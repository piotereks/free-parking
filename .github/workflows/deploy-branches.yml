name: Deploy to GitHub Pages (Branch-Specific)

on:
  push:
    branches-ignore:
      - main
    # branches:
    #   - main
    #   - 'feature/**'
    #   - 'fix/**'
    #   - 'dev/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      # - name: Verify DEPLOY_TOKEN secret
      #   run: |
      #     if [ -z "${{ secrets.DEPLOY_TOKEN }}" ]; then
      #       echo "::error::DEPLOY_TOKEN secret is not set. Please configure it in repository settings."
      #       echo "::error::Go to: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
      #       exit 1
      #     fi
      #     echo "‚úì DEPLOY_TOKEN is configured"
      
      - name: Determine deployment path and base URL
        id: deployment-config
        run: |
          # Get the branch name
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          echo "Branch name: $BRANCH_NAME"
          # Repository owner and name
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"
          echo "Repository: ${OWNER}/${REPO}"
          
          # Normalize branch name for use in paths
          # Replace: / (slash), . (dot), _ (underscore) with - (hyphen), then convert to lowercase
          NORMALIZED_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[/\._]/-/g' | tr '[:upper:]' '[:lower:]')
          echo "Normalized branch: $NORMALIZED_BRANCH"
          
          # Determine destination directory and base path
          if [ "$BRANCH_NAME" = "main" ]; then
            # Main branch deploys to the primary location
            DEST_DIR="./"
            BASE_PATH="/${REPO}/"
            echo "Deploying main branch to primary location"
          else
            # Other branches deploy to branch-specific subfolders
            DEST_DIR="${NORMALIZED_BRANCH}/"
            BASE_PATH="/${REPO}/${NORMALIZED_BRANCH}/"
            echo "Deploying branch '$BRANCH_NAME' to subfolder: $DEST_DIR"
          fi
          
          # Set outputs for use in subsequent steps
          echo "dest_dir=${DEST_DIR}" >> $GITHUB_OUTPUT
          echo "base_path=${BASE_PATH}" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_NAME}" >> $GITHUB_OUTPUT
          echo "normalized_branch=${NORMALIZED_BRANCH}" >> $GITHUB_OUTPUT
          
          # Log the configuration
          echo "::notice::Destination Directory: ${DEST_DIR}"
          echo "::notice::Base Path: ${BASE_PATH}"
      
      - name: Build with branch-specific configuration
        env:
          VITE_BASE_PATH: ${{ steps.deployment-config.outputs.base_path }}
        run: |
          echo "Building with base path: $VITE_BASE_PATH"
          npm run build
      
      - name: Prepare publish directory
        run: |
          DEST_DIR="${{ steps.deployment-config.outputs.dest_dir }}"
          # SUBDIR is the tail after docs/html/ (e.g. parking or parking-feature-x)
          SUBDIR="${DEST_DIR}"
          mkdir -p "parking-deploy/docs/html/${SUBDIR}"
          # Move built files into the branch-specific subfolder
          mv -v parking-deploy/docs/html/parking/* "parking-deploy/docs/html/${SUBDIR}/" || true
          # Remove the (now-empty) default parking folder if present
          rm -rf parking-deploy/docs/html/parking || true

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./parking-deploy/docs/html

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
      
      - name: Display deployment URL
        run: |
          DEST_DIR="${{ steps.deployment-config.outputs.dest_dir }}"
          BRANCH_NAME="${{ steps.deployment-config.outputs.branch_name }}"
          NORMALIZED="${{ steps.deployment-config.outputs.normalized_branch }}"
          OWNER="${GITHUB_REPOSITORY%%/*}"
          REPO="${GITHUB_REPOSITORY#*/}"

          if [ "$BRANCH_NAME" = "main" ]; then
            URL="https://${OWNER}.github.io/${REPO}/"
          else
            URL="https://${OWNER}.github.io/${REPO}/${NORMALIZED}/"
          fi
          
          echo "::notice::‚úÖ Deployment successful!"
          echo "::notice::üìç Deployed to: ${DEST_DIR}"
          echo "::notice::üîó URL: ${URL}"
          echo ""
          echo "Deployment Summary:"
          echo "==================="
          echo "Branch: ${BRANCH_NAME}"
          echo "Destination: ${DEST_DIR}"
          echo "URL: ${URL}"
